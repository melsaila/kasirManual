"use strict";
var jPenugasan = (function() {
    var hd = "",
        grid = "",
        pmsg = "",
        v = false,
        obj = "",
        s = false;
    grid = '#gtaxipenugasan';

    function init(x) {
        hd = new Gtaxi();
        hd.setkey(x);
    }

    function rd() {
        if (hd instanceof Gtaxi) {
            return hd;
        } else {
            return undefined;
        }
    }
    function getimei(f,s){
        var optimei = [];
        optimei.push('<option value="">Pilih Imei ?</option>');
        rd().sendto('imei/getimei',null,'get').done(function(rsp){
            pmsg = $.parseJSON(rsp);
            if(parseInt(pmsg.length) > 0){
                $.each(pmsg, function(i, c) {
                    optimei.push('<option value="' + c.imei + '">' + c.imei + '</option>');
                });
            }else{
                optimei.push('<option value="">Imei tidak tersedia</option>');
            }
            $('form[id="' + f + '"] select[name="' + s + '"]').html(optimei);
        }).fail(function(){
            optimei.push('<option value="">Daftarkan perangkat terlebih dahulu</option>');
            $('form[id="' + f + '"] select[name="' + s + '"]').html(optimei);
        });
    }
    function getsopir(f,s){
        var optsopir = [];
        optsopir.push('<option value="">Pilih Sopir ?</option>');
        rd().sendto('drivers/getsopir',null,'get').done(function(rsp){
            pmsg = $.parseJSON(rsp);
            if(parseInt(pmsg.length) > 0){
                $.each(pmsg, function(i, c) {
                    optsopir.push('<option value="' + c.nik + '">' + c.name + '</option>');
                });
            }else{
                optsopir.push('<option value="">Sopir tidak tersedia</option>');
            }
            $('form[id="' + f + '"] select[name="' + s + '"]').html(optsopir);
        }).fail(function(){
            optimei.push('<option value="">Daftarkan sopir terlebih dahulu</option>');
            $('form[id="' + f + '"] select[name="' + s + '"]').html(optsopir);
        });
    }
    function gettaxi(f,s){
        var opttaxi = [];
        opttaxi.push('<option value="">Pilih Taksi ?</option>');
        rd().sendto('cars/getcar',null,'get').done(function(rsp){
            pmsg = $.parseJSON(rsp);
            if(parseInt(pmsg.length) > 0){
                $.each(pmsg, function(i, c) {
                    opttaxi.push('<option value="' + c.id_car + '">' + c.taxi_number + '</option>');
                });
            }else{
                opttaxi.push('<option value="">Taksi tidak tersedia</option>');
            }
            $('form[id="' + f + '"] select[name="' + s + '"]').html(opttaxi);
        }).fail(function(){
            optimei.push('<option value="">Daftarkan taksi terlebih dahulu</option>');
            $('form[id="' + f + '"] select[name="' + s + '"]').html(opttaxi);
        });
    }
    return {
        init: function(a) {
            init(a);
        },
        grid: function() {
            $(grid).datagrid({
                url: rd().site_url("penugasan/selects"),
                nowrap: true,
                singleSelect: true,
                rownumbers: true,
                fit: true,
                striped: true,
                autoRowHeight: false,
                pagination: true,
                fitColumns: false,
                method: "post",
                halign: "center",
                queryParams: {
                    'taxixkey': rd().getkey()
                },
                columns: [
                    [{
                        halign: "center",
                        field: "name",
                        title: "Sopir"
                    }, {
                        halign: "center",
                        align: "center",
                        field: "imei",
                        title: "Imei",
                        width: "200"
                    }, {
                        halign: "center",
                        align: "center",
                        field: "taxi_number",
                        title: "No.Taksi",
                        width: "100"
                    }, {
                        halign: "center",
                        align: "center",
                        field: "license_plate",
                        title: "No.Polisi",
                        width: "100"
                    }]
                ]
            });
        },
        dlgpenugasan: function(){
            rd().opndlg('#dlgipenugasan','Penugasan Taksi');
            document.forms['fcpenugasan'].reset();
            gettaxi('fcpenugasan','ptaksi');
            getsopir('fcpenugasan','psopir');
            getimei('fcpenugasan','pimei');
        },
        dlgtaxi: function(){
            rd().opndlg();
            document.forms[''].reset();
            gettaxi();
        },
        dlgimei: function(){
            rd().opndlg();
            document.forms[''].reset();
            getimei();
        },
        dlgsopir: function(){
            rd().opndlg();
            document.forms[''].reset();
            getsopir();
        },
        updtaxi: function(u){},
        updimei: function(u){},
        updsopir: function(u){},
        addpenugasan: function(u){
            v = $('#fcpenugasan').form('validate');
            if(v){
                rd().sendto(u, $('form[id="fcpenugasan"]').serialize()+'&taxixkey='+rd().getkey()).done(function(rsp){
                    pmsg = $.parseJSON(rsp);
                    if(pmsg.result == 'success'){
                        rd().clsdlg('#dlgipenugasan');
                        rd().messageok('Penugasan Taksi',pmsg.message);
                        rd().rload(grid);
                    }else{
                        rd().messageok('Penugasan Taksi',pmsg.message);
                    }
                }).fail(function(){
                    rd().messagebad('Penugasan')
                });
            }
        },
        dlginserttaxi: function() {
            rd().opndlg("#dlgitaxi", "Daftar Taksi");
            document.forms['fctaxi'].reset();
            loadorphanimei('fctaxi', 'imei');
        },
        dlgedittaxi: function() {},
        inserttaxi: function(u) {
            v = $('#fctaxi').form('validate');
            if (v) {
                obj = $('form[id="fctaxi"]').serialize() + '&taxixkey=' + rd().getkey();
                rd().sendto(u, obj).done(function(rsp) {
                    pmsg = $.parseJSON(rsp);
                    if (pmsg.result == 'success') {
                        rd().clsdlg('#dlgitaxi');
                        rd().messageok('Daftar Taksi', pmsg.message);
                        rd().rload(grid);
                    } else {
                        rd().messageok('Daftar Taksi', pmsg.message);
                    }
                }).fail(function() {
                    rd().messagebad('Daftar Perangkat');
                });
            }
        },
        dlgaddtxdevice: function() {
            s = $(grid).datagrid('getSelected');
            if (s) {
                if (s.imei == '' || s.imei == null) {
                    rd().opndlg('#dlgaddtxdvc', 'Menugaskan perangkat');
                    document.forms['faddtxdvc'].reset();
                    $('#faddtxdvc').form('load', s);
                    loadorphanimei('faddtxdvc', 'imei');
                } else {
                    $.messager.alert("Information", "Hanya taksi tidak mempunyai imei yang diijinkan");
                }
            } else {
                $.messager.alert("Information", "Silakan pilih data terlebih dahulu");
            }
        },
        addtxdevice: function(u) {
            v = $('#faddtxdvc').form('validate');
            if (v) {
                if($('form[id="faddtxdvc"] select[name="imei"]').val() != ''){
                    obj = $('form[id="faddtxdvc"]').serialize() + '&taxixkey=' + rd().getkey();
                    rd().sendto(u, obj).done(function(rsp) {
                        pmsg = $.parseJSON(rsp);
                        if (pmsg.result == 'success') {
                            rd().clsdlg('#dlgaddtxdvc');
                            rd().messageok('Menugaskan Perangkat', pmsg.message);
                            rd().rload(grid);
                        } else {
                            rd().messageok('Menugaskan Perangkat', pmsg.message);
                        }
                    }).fail(function() {
                        rd().messagebad('Menugaskan Perangkat');
                    });
                }else{
                    rd().messageok('Menugaskan Perangkat', 'Silakan daftarkan imei perangkat!');
                    return;
                }
            }
        },
        deltxdevice: function(u) {
            s = $(grid).datagrid('getSelected');
            if (s) {
                console.info(s.imei);
                if (s.imei == '' || s.imei == null) {
                    $.messager.alert("Information", "Hanya taksi tidak mempunyai imei yang diijinkan");
                    return;
                }
                $.messager.confirm("Hapus perangkat - Konfirmasi", "Yakin akan menghapus perangkat : " + s.nomor_polisi + " ?", function(c) {
                    if (c) {
                        obj = new Object({
                            'nik': s.nik,
                            'taxixkey': rd().getkey()
                        });
                        rd().sendto(u, obj).done(function(d) {
                            pmsg = $.parseJSON(d);
                            if (pmsg.result == "success") {
                                rd().messageok("Hapus perangkat taksi", pmsg.message);
                                rd().rload(grid);
                            } else {
                                rd().messagebad('Hapus perangkat taksi', pmsg.message);
                            }
                        }).fail(function() {
                            rd().messagebad('Hapus perangkat');
                        });
                    }
                });
            }
        },
        deltaxi: function(u) {
            s = $(grid).datagrid('getSelected');
            if (s) {
                $.messager.confirm("Hapus perangkat - Konfirmasi", "Yakin akan menghapus perangkat : " + s.nomor_polisi + " ?", function(c) {
                    if (c) {
                        obj = new Object({
                            'nik': s.nik,
                            'taxixkey': rd().getkey()
                        });
                        rd().sendto(u, obj).done(function(d) {
                            pmsg = $.parseJSON(d);
                            if (pmsg.result == "success") {
                                rd().messageok("Perangkat taksi", pmsg.message);
                                rd().rload(grid);
                            } else {
                                rd().messagebad('Perangkat taksi', pmsg.message);
                            }
                        }).fail(function() {
                            rd().messagebad('Perangkat taksi');
                        });
                    }
                });
            }
        },
        dlginsertdevice: function() {
            rd().opndlg("#dlgiimei", "Daftar Perangkat");
            document.forms['fcimei'].reset();
        },
        insertdevice: function(u) {
            v = $('#fcimei').form('validate');
            if (v) {
                obj = $('form[id="fcimei"]').serialize() + '&taxixkey=' + rd().getkey();
                rd().sendto(u, obj).done(function(rsp) {
                    pmsg = $.parseJSON(rsp);
                    if (pmsg.result == 'success') {
                        rd().clsdlg('#dlgiimei');
                        rd().clsdlg('#dlgitaxi');
                        rd().clsdlg('#dlgaddtxdvc');
                        rd().messageok('Daftar Perangkat', pmsg.message);
                        rd().rload(grid);
                    } else {
                        rd().messagebad('Daftar Perangkat', pmsg.message);
                    }
                }).fail(function() {
                    rd().messagebad('Daftar Perangkat');
                });
            }
        }
    }
})();

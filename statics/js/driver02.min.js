"use strict";
var hd1 = "";
var jDrivers = (function() {
    var hd = "",
        v = false,
        s = "",
        pmsg = "",
        grid = "#gdrivers",
        kx = "",
        objs = "";

    function init(x) {
        hd = new Gtaxi();
        hd.setkey(x);
    }

    function rd() {
        if(hd instanceof Gtaxi){
            return hd;
        }else{
            return undefined;
        }
    }
    function a(d, e, g) {
        $(grid).datagrid("load", {
            search : e,
            keyword : g,
            'taxixkey' : rd().getkey()
        });
        setTimeout(function () {
            $('tr>td:contains("' + g + '")').css({
                background : "yellow",
                color : "black",
                "font-weight" : "bold"
            })
        }, 1000)
    }
    function dosearch(g, o, l, d) {
        var n = "",
        b = 1500,
        k = "",
        j = "",
        h = "",
        i = "",
        f = null,
        j = document.getElementById(g),
        h = document.getElementById(o),
        i = d || "1";
        j.onchange = function () {
            h.value = "";
            k = j.options[j.selectedIndex].value;
            if (k == "") {
                return
            }
            h.onkeyup = function () {
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9\s\.\_\-]/g, "");
                f = this.value.toUpperCase().replace(/[^A-Z0-9\s\.\_\-]/g, "");
                if (parseInt(f.length) > parseInt(i)) {
                    clearTimeout(n);
                    n = setTimeout(function () {
                            a(l, k, f)
                        }, b)
                } else {
                    return
                }
            };
            h.keydown = function () {
                clearTimeout(n)
            }
        }
    }
    function gettaxi(n1,n2) {
        var temp = ['<option value="">-----------------</option>'];
        rd().sendto('drivers/gettaxi', null).done(function(rsp){
            pmsg = $.parseJSON(rsp);
            if(pmsg.total > 0){
                $.each(pmsg.rows, function(i,c){
                    temp.push('<option value="'+c.nik+','+c.taxi_number+','+c.nomor_polisi+','+c.imei+'">'+c.taxi_number +' | ' +c.nomor_polisi+'</option>');
                });
            }else{
                 temp.push('<option value="">Taksi tidak tersedia</option>');
            }
            $('form[id="' + n1 + '"] select[name="' + n2 + '"]').html(temp);
        }).fail(function(){
            temp.push('<option value="">Silakan daftar taksi</option>');
            $('form[id="' + n1 + '"] select[name="' + n2 + '"]').html(temp);
        });
    }
    return {
        init: function(x) {
            init(x);
        },
        searchgrid : function () {
            dosearch("terminalsearch", "terminalkeyword", "gdrivers","0");
        },
        grid: function() {
            $(grid).datagrid({
                url: rd().site_url("drivers/selects"),
                nowrap: true,
                singleSelect: true,
                rownumbers: true,
                fit: true,
                striped: true,
                autoRowHeight: false,
                pagination: true,
                fitColumns: false,
                method: "post",
                halign: "center",
                queryParams: {
                    'taxixkey':rd().getkey()
                },
                columns: [
                    [{
                        halign: "center",
                        field: "nik",
                        title: "Nik",
                        width: 100
                    },{
                        halign: "center",
                        field: "imei_taxi",
                        title: "Imei",
                        width: 100
                    },{
                        halign: "center",
                        field: "fullname",
                        title: "Nama",
                        width: 100
                    }, {
                        halign: "center",
                        align: "center",
                        field: "phone",
                        title: "Telepon",
                    },{
                        halign: "center",
                        align: "center",
                        field: "statuslogin",
                        title: "Status Login",
                        width: 100
                    }, {
                        halign: "center",
                        align: "center",
                        field: "address",
                        title: "Alamat",
                        width: 100
                    }, {
                        halign: "center",
                        field: "email",
                        title: "Email",
                    }, {
                        halign: "center",
                        field: "username",
                        title: "Username",
                        width: 100
                    }]
                ]
            });
        },
        dlginsert: function() {
            rd().opndlg("#dlgidrivers", "Daftar Sopir");
            document.forms['fcdrivers'].reset();
        },
        insert: function(u) {
            v = $('#fcdrivers').form('validate');
            if (v) {
                rd().sendto(u, $('form[id="fcdrivers"]').serialize()+ '&taxixkey=' + rd().getkey()).done(function(rsp) {
                    pmsg = $.parseJSON(rsp);
                    if (pmsg.result == 'success') {
                        rd().messageok('Daftar Taksi', pmsg.message);
                        rd().clsdlg("#dlgidrivers");
                        rd().rload(grid);
                    } else {
                        rd().messagebad('Daftar Taksi', pmsg.message);
                    }
                }).fail(function() {
                    rd().messagebad('Daftar Taksi', 'Errors occured.Proccess terminated');
                });
            }
        },
        dlgupt: function() {
            s = $(grid).datagrid('getSelected');
            console.log(s);
            if(s){

                document.forms['fedrivers'].reset();
                rd().opndlg("#dlgedrivers","Edit Driver " + s.name);
                $("#fedrivers").form("load", s);
            }else{
                $.messager.alert('info','Pilih data terlebih dahulu');
            }
        },
        update: function(u) {
            v = $('#fedrivers').form('validate');
            if(v){ 
                objs = $('form[id="fedrivers"]').serialize() + '&taxixkey=' + rd().getkey();
                rd().sendto(u, objs).done(function(rsp) {
                    pmsg = $.parseJSON(rsp);
                    if (pmsg.result == 'success') {
                        rd().messageok('Edit Sopir', pmsg.message);
                        rd().clsdlg("#dlgedrivers");
                        rd().rload(grid);
                    } else {
                        rd().messagebad('Edit Sopir', pmsg.message);
                    }
                }).fail(function() {
                    rd().messagebad('Edit Sopir', 'Errors occured.Proccess terminated');
                });
            }
        },
        del: function(u) {
            s = $(grid).datagrid("getSelected");
			if (s) {
                $.messager.confirm("Hapus Sopir - Konfirmasi", "Yakin akan menghapus sopir : " + s.fullname + " ?", function(c) {
                    if (c) {
                        objs = new Object({
                            'nik': s.nik,
                            'taxixkey': rd().getkey()
                        });
                        rd().sendto(u, objs).done(function(d) {
                            pmsg = $.parseJSON(d);
                            if (pmsg.result == "success") {
                                rd().messageok("Hapus Sopir", pmsg.message);
                                rd().rload(grid);
                            } else {
                                rd().messagebad('Hapus Sopir', pmsg.message);
                            }
                        }).fail(function() {
                            rd().messagebad('Hapus Sopir', 'Errors occured.Proccess terminated');
                        });
                    }
                });
            }
        }
    }
})();
$(function () {
    jDrivers.init('keys');
    jDrivers.grid();
    jDrivers.searchgrid()
});




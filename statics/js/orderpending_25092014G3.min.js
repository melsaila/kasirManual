"use strict";
var hd = "";
var s="";
var pmsg="";
var tempgrid="";
var grid = "#gorderpending";
var jOrderpending = (function() {
    var 
        v="",
        interval=0,
        tempInterval=0,
        sample=0,
        e=0,
        looping=0,
        loopindex=[],
        loopvalue=[];

    function init(x) {
        hd = new Gtaxi();
        hd.setkey(x);
    }

    function rd() {
        if (hd instanceof Gtaxi) {
            return hd;
        } else {
            return undefined;
        }
    }
     function grid_refresh() {
         
        $(grid).datagrid("reload");
        // console.log(grid);
        //grid.trigger("reloadGrid");
        setTimeout(grid_refresh, 3000); // schedule next refresh after 15sec
    }
    function a(d, e, g) {
        $(grid).datagrid("load", {
            search : e,
            keyword : g,
            'taxixkey' : rd().getkey()
        });
        setTimeout(function () {
            $('tr>td:contains("' + g + '")').css({
                background : "yellow",
                color : "black",
                "font-weight" : "bold"
            })
        }, 1000)
    }
 
     function myTimer(looping, value) {
            value++;
            for (var i = 0; i>loopindex[looping]; i++) {
                alert(value);

                value++;
                loopvalue[looping]++;

            };
            var hour = Math.floor(value/3600);
            var minute = Math.floor((value/60)%60);
            if(minute<10)
                minute="0"+minute;
            var seconds = value % 60;
            if(seconds<10)
                seconds="0"+seconds;
            var waktu=hour+":"+minute+":"+seconds;
            document.getElementById(looping).innerHTML = waktu;
            
        
    }

    function FuncdlgProsesPemesanan(index){
        rd().opndlg("#dlgProsesPemesanan", "Proses Pemesanan");
        document.forms['fProsPemesanan'].reset();
    }
    function dosearch(g, o, l, d) {
        var n = "",
        b = 1500,
        k = "",
        j = "",
        h = "",
        i = "",
        f = null,
        j = document.getElementById(g),
        h = document.getElementById(o),
        i = d || "1";
        j.onchange = function () {
            h.value = "";
            k = j.options[j.selectedIndex].value;
            if (k == "") {
                return
            }
            h.onkeyup = function () {
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9\s\.\_\-]/g, "");
                f = this.value.toUpperCase().replace(/[^A-Z0-9\s\.\_\-]/g, "");
                if (parseInt(f.length) > parseInt(i)) {
                    clearTimeout(n);
                    n = setTimeout(function () {
                            a(l, k, f)
                        }, b)
                } else {
                    return
                }
            };
            h.keydown = function () {
                clearTimeout(n)
            }
        }
    }
    return {
        init: function(a) {
            init(a);
        },
        searchgrid : function () {
            dosearch("terminalsearch", "terminalkeyword", "gorderpending","0");
        },
        refresh : function () {
            grid_refresh();
        },
        table_grid: function() {
            $(grid).datagrid({
                url: rd().site_url("orderpending/selects"),
                region: 'center',
                nowrap: true,
                singleSelect: true,
                rownumbers: true,
                fit: true,
                striped: true,
                autoRowHeight: true,
                pagination: true,
                fitColumns: false,
                method: "post",
                halign: "center",
                queryParams: {
                    'taxixkey': rd().getkey()
                },
                columns: [
                    [{
                        halign: "center",
                        field: "idorder",
                        title: "Id Order"
                    },  {
                        halign: "center",
                        field: "status",
                        title: "Status"
                        // title: "Request Time",
                        // formatter:function(value,row,index){
                        //     //var e='<span id=W></span>';
                        //     e ='<span id="'+index+'"></span>';
                            
                        //     // loop[index] = index;
                        //     // //alert("span"+e);
                        //     // //var myVar = setInterval(function(){myTimer(tempInterval, tempDate);}, 1000);
                        //     // alert(loop[index]);
                        //        var myVar = setInterval(function(){myTimer(index, value);}, 1000);
                            
                        //     return e;
                        // }
                    },  {
                        halign: "center",
                        field: "id_request",
                        title: "Status"
					}, {
                        halign: "center",
                        field: "Action",
                        title: "Action",
                        formatter:function(value,row,index){
                            
                            var button1 = '<button class="btn btn-primary btn-md" onclick="jOrderpending.dlgConfPemesanan();">Proses</button>';
                            var button2 = '<button class="btn btn-default btn-md" onclick="jOrderpending.dlgConfBatal();">Batal</button>';
                            return button1+button2;
                        }
                    }]
                ]
            });
        }, insertSukses: function(u) {
            v = $('#fProsPemesanan').form('validate');
            if (v) {
                rd().sendto(u, $('form[id="fProsPemesanan"]').serialize()+ '&taxixkey=' + rd().getkey()).done(function(rsp) {
                    pmsg = $.parseJSON(rsp);
                    if (pmsg.result == 'success') {
                        rd().rload(grid);
                        $('#dlgProsesPemesanan').dialog('close');
                        if(pmsg){
                            document.forms['fCPemesanan'].reset();
                            rd().opndlg("#dlgKonfirmasi","Pemesanan Taksi Atas Nama " + pmsg.name);
                            $("#fCPemesanan").form("load", pmsg);
                        }else{
                            $.messager.alert('info','Pilih data terlebih dahulu');
            }
                    } else {
                        rd().messagebad('Daftar Taksi', pmsg.message);
                    }
                }).fail(function() {
                    rd().messagebad('Daftar Taksi', 'Errors occured.Proccess terminated');
                });
            }
        },
        insertBatal: function(u) {
            v = $('#fProsBatal').form('validate');
            if (v) {
                rd().sendto(u, $('form[id="fProsBatal"]').serialize()+ '&taxixkey=' + rd().getkey()).done(function(rsp) {
                    pmsg = $.parseJSON(rsp);
                    if (pmsg.result == 'success') {
                        rd().rload(grid);
                        $('#dlgProsesBatal').dialog('close');
                        if(s){
                            document.forms['fCPemesananBatal'].reset();
                            rd().opndlg("#dlgKonfirmasiBatal","Pemesanan Taksi Atas Nama " + pmsg.name);
                            $("#fCPemesananBatal").form("load", pmsg);
                        }else{
                            $.messager.alert('info','Pilih data terlebih dahulu');
            }
                    } else {
                        rd().messagebad('Daftar Taksi', pmsg.message);
                    }
                }).fail(function() {
                    rd().messagebad('Daftar Taksi', 'Errors occured.Proccess terminated');
                });
            }
        },

        dlgConfPemesanan: function(target){
            s = $(grid).datagrid('getSelected');
            if(s){
                document.forms['fProsPemesanan'].reset();
                rd().opndlg("#dlgProsesPemesanan","Pemesanan Taksi Atas Nama " + s.name);
                $("#fProsPemesanan").form("load", s);
            }else{
                $.messager.alert('info','Pilih data terlebih dahulu');
            }
        },
        dlgConfBatal: function(){
            s = $(grid).datagrid('getSelected');
            if(s){
                document.forms['fProsBatal'].reset();
                rd().opndlg("#dlgProsesBatal","Pemesanan Taksi Atas Nama " + s.name);
                $("#fProsBatal").form("load", s);
            }else{
                $.messager.alert('info','Pilih data terlebih dahulu');
            }
        }
    }
})();
// function vmaps_pending(){
//     $('#vmaps_pending').load('http://localhost/taksi-dev/taximaps');
// }
// function getRowIndex(target){
//     var tr = $(target).closest('tr.datagrid-row');
//             return parseInt(tr.attr('datagrid-row-index'));
//         }

$(function () {
        jOrderpending.init('keys');  
    jOrderpending.table_grid();
    jOrderpending.searchgrid();
    //jOrderpending.refresh();
});
